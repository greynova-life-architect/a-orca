<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Map</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
</head>
<body>
  <div class="app-wrapper" x-data="projectMapApp()" x-init="init()">
    <aside class="app-sidebar">
      <div class="sidebar-header">
        <span class="logo">Project Map</span>
      </div>
      <div class="sidebar-actions">
        <button class="btn btn-sidebar-primary" @click="openNewProjectModal()">+ New project</button>
        <button class="btn btn-sidebar-secondary" @click="openAttachModal()">Attach</button>
      </div>
      <div class="sidebar-projects">
        <div class="sidebar-label">Projects</div>
        <template x-for="p in projectList" :key="p.id">
          <button type="button" class="sidebar-project-item" :class="{ active: currentProjectId === p.id }" @click="loadProject(p.id)">
            <span class="project-item-name" x-text="p.name || p.id"></span>
          </button>
        </template>
        <div class="sidebar-empty" x-show="!projectList.length">No projects yet</div>
      </div>
    </aside>

    <div class="app-content">
      <header class="app-header">
        <div class="header-left">
          <span class="project-title" x-show="project.name" x-text="project.name"></span>
          <span class="project-title placeholder" x-show="!project.name">Select a project</span>
          <span class="project-meta" x-show="project.name" x-text="project.type + ' ¬∑ ' + features.length + ' features ¬∑ ' + mapNodes.length + ' tasks'"></span>
        </div>
        <div class="header-right">
          <select class="form-select form-select-sm user-select" style="width: auto;" x-model="currentUser">
            <template x-for="u in users" :key="u.id">
              <option :value="u.id" x-text="u.name"></option>
            </template>
          </select>
        </div>
      </header>

      <main class="app-main">
        <div class="main-tabs-wrap">
        <div class="main-tabs">
          <button class="btn btn-sm" :class="mainTab === 'planning' ? 'btn-primary' : 'btn-outline-secondary'" @click="mainTab = 'planning'">Agent Planning</button>
          <button class="btn btn-sm" :class="mainTab === 'analysis' ? 'btn-primary' : 'btn-outline-secondary'" @click="mainTab = 'analysis'">Detailed Analysis</button>
          <button class="btn btn-sm" :class="mainTab === 'board' ? 'btn-primary' : 'btn-outline-secondary'" @click="mainTab = 'board'">Board</button>
          <button class="btn btn-sm" :class="mainTab === 'features' ? 'btn-primary' : 'btn-outline-secondary'" @click="mainTab = 'features'">Features</button>
          <button class="btn btn-sm" :class="mainTab === 'folder' ? 'btn-primary' : 'btn-outline-secondary'" @click="mainTab = 'folder'" x-show="project.root_path">Folder</button>
        </div>
        </div>

        <!-- Agent Planning: single centered chat -->
        <div class="planning-view" x-show="mainTab === 'planning'">
          <div class="chat-centering">
            <div class="chat-container">
              <div class="chat-messages-area">
                <div class="chat-msg-row chat-msg-assistant text-muted" x-show="!projectChatMessages.length && !cursorWaiting">
                  <span class="chat-msg-role">Assistant</span>
                  <div class="chat-msg-content">Choose a topic, type your message, and click Send. Use Planning or Tasks to create tasks with the Cursor agent.</div>
                </div>
                <template x-for="(m, i) in projectChatMessages" :key="i">
                  <div class="chat-msg-row" :class="'chat-msg-' + (m.role || 'assistant')">
                    <span class="chat-msg-role" x-text="m.role === 'user' ? 'You' : (m.role === 'system' ? 'Note' : 'Assistant')"></span>
                    <div class="chat-msg-content" x-text="m.content"></div>
                  </div>
                </template>
                <template x-if="pendingQuestions !== null && !cursorWaiting">
                  <div class="chat-questions-inline p-3 rounded border border-secondary mb-2">
                    <div class="chat-context-label mb-2">Planning assistant</div>
                    <span class="chat-question-count small text-muted" x-show="pendingQuestions && pendingQuestions.length" x-text="(currentQuestionIndex + 1) + ' of ' + (pendingQuestions?.length || 0)"></span>
                    <div class="chat-msg-row chat-msg-assistant mt-2" x-show="pendingQuestions && pendingQuestions.length">
                      <div class="chat-msg-content" x-text="pendingQuestions[currentQuestionIndex]?.question"></div>
                      <small class="text-muted d-block mt-1" x-show="pendingQuestions[currentQuestionIndex]?.hint" x-text="pendingQuestions[currentQuestionIndex]?.hint"></small>
                    </div>
                    <div class="chat-msg-row chat-msg-assistant mt-2" x-show="!pendingQuestions || !pendingQuestions.length">
                      <div class="chat-msg-content">No clarifying questions. Proceed to create plan.</div>
                    </div>
                    <div class="d-flex gap-1 mt-2">
                      <button type="button" class="btn btn-sm btn-outline-secondary" @click="prevQuestion()" :disabled="currentQuestionIndex <= 0">Previous</button>
                      <button type="button" class="btn btn-sm btn-outline-primary" @click="nextQuestion()" :disabled="currentQuestionIndex >= (pendingQuestions?.length || 1) - 1">Next</button>
                      <button type="button" class="btn btn-sm btn-success" @click="generatePlanFromAnswers()">Generate Plan</button>
                    </div>
                  </div>
                </template>
                <div class="cursor-confirm-panel cursor-confirm-in-chat p-3 rounded border border-success mb-2" x-show="pendingPlan && !cursorWaiting && !pendingQuestions" x-cloak>
                  <strong>Review plan</strong>
                  <p class="mb-2 mt-2">Confirm this plan to create tasks.</p>
                  <div class="plan-preview mb-3">
                    <div class="plan-project">
                      <span class="project-type-badge" x-text="pendingPlan?.project?.type"></span>
                      <span class="plan-name" x-text="pendingPlan?.project?.name"></span>
                    </div>
                    <p class="plan-summary text-muted small mt-2 mb-2" x-show="pendingPlan?.project?.summary" x-text="pendingPlan?.project?.summary"></p>
                    <ul class="plan-features">
                      <template x-for="f in (pendingPlan?.features || [])" :key="f.id">
                        <li><span x-text="f.name"></span><span class="text-muted small" x-text="' ‚Äî ' + (f.description || '')"></span></li>
                      </template>
                    </ul>
                  </div>
                  <div class="task-preview mb-3" x-show="taskPreviewFromPlan.length">
                    <strong class="d-block mb-2">Tasks to be created</strong>
                    <p class="text-muted small mb-2">Assign an agent to each task, then click Create Task.</p>
                    <ul class="task-preview-list task-preview-with-agents">
                      <template x-for="t in taskPreviewFromPlan" :key="t.id">
                        <li class="task-preview-item">
                          <div class="task-preview-main">
                            <span x-text="t.title"></span>
                            <span class="text-muted small" x-show="t.description" x-text="' ‚Äî ' + t.description"></span>
                          </div>
                          <select class="form-select form-select-sm task-agent-select" @change="assignAgentToTask(t.id, $event.target.value)">
                            <template x-for="a in agents" :key="a.id">
                              <option :value="a.id" :selected="t.agent_id === a.id" x-text="a.name"></option>
                            </template>
                          </select>
                        </li>
                      </template>
                    </ul>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-success" @click="confirmPlan()">Create Task</button>
                    <button class="btn btn-outline-secondary" @click="regeneratePlan()">Regenerate</button>
                  </div>
                </div>
                <div class="alert alert-danger mb-2" x-show="cursorError" x-cloak><span x-text="cursorError"></span></div>
                <div class="alert alert-success mb-2" x-show="cursorTestResult && !cursorWaiting" x-cloak><span x-text="cursorTestResult"></span></div>
                <div class="cursor-status-panel cursor-status-inline mb-2" x-show="cursorWaiting" x-cloak>
        <div class="cursor-status-header">
          <strong x-text="cursorPhaseLabel"></strong>
          <span class="cursor-status-badge">‚óè Running</span>
        </div>
        <template x-if="['questions','plan','task'].includes(cursorPhase)">
          <div class="cursor-phase-progress mt-2 mb-2">
            <div class="phase-steps">
              <span class="phase-step" :class="{ 'phase-step-done': cursorPhaseStepIndex > 0, 'phase-step-active': cursorPhaseStepIndex === 0 }">1. Questions</span>
              <span class="phase-step" :class="{ 'phase-step-done': cursorPhaseStepIndex > 1, 'phase-step-active': cursorPhaseStepIndex === 1 }">2. Plan</span>
              <span class="phase-step" :class="{ 'phase-step-done': cursorPhaseStepIndex > 2, 'phase-step-active': cursorPhaseStepIndex === 2 }">3. Tasks</span>
            </div>
          </div>
        </template>
        <template x-if="cursorPhase === 'assess' && cursorAssessFolder">
          <div class="cursor-assess-folder">
            <span class="cursor-assess-folder-icon">üìÅ</span>
            <span class="cursor-assess-folder-path" x-text="cursorAssessFolder" :title="cursorAssessFolder"></span>
          </div>
        </template>
        <template x-if="cursorPhase === 'assess' && cursorAssessStep.step">
          <div class="cursor-assess-steps mt-2 mb-2">
            <div class="cursor-step-indicator" x-text="'Step ' + cursorAssessStep.step + ' of ' + cursorAssessStep.total + ': ' + (cursorAssessStep.label || '')"></div>
            <div class="cursor-step-message text-muted small" x-text="cursorAssessStep.message"></div>
          </div>
        </template>
        <div class="cursor-status-current" x-text="cursorStatusMessage || 'Starting Cursor Agent...'"></div>
        <div class="cursor-agent-active-indicator" x-show="cursorPhase !== 'assess'">
          <span class="agent-active-dots">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          </span>
          <span class="agent-active-text">Agent is working‚Ä¶</span>
          <span class="agent-active-hint text-muted small">(Stream is live ‚Äî new output appears below)</span>
        </div>
        <template x-if="cursorPhase === 'assess' && cursorAssessPrompt">
          <div class="cursor-assess-prompt mt-2">
            <div class="cursor-assess-prompt-label">Initial planning prompt (full context)</div>
            <pre class="cursor-assess-prompt-content p-3 rounded border overflow-auto" x-text="cursorAssessPrompt" style="max-height: 45vh; font-size: 0.8rem; white-space: pre-wrap; line-height: 1.5;"></pre>
          </div>
        </template>
        <template x-if="cursorAgentActivity && cursorAgentActivity.length">
          <div class="cursor-agent-activity cursor-agent-activity-clickable mt-2" @click="agentActivityExpanded = !agentActivityExpanded">
            <div class="cursor-agent-activity-title">
              Agent activity (files reviewed)
              <span class="agent-activity-count" x-text="'(' + cursorAgentActivity.length + ')'"></span>
            </div>
            <div class="cursor-agent-activity-list" :class="{ 'agent-activity-expanded': agentActivityExpanded }">
              <template x-if="!agentActivityExpanded">
                <div class="agent-activity-item agent-activity-single">
                  <span class="agent-activity-label" x-text="(cursorAgentActivity[cursorAgentActivity.length - 1]?.label || cursorAgentActivity[cursorAgentActivity.length - 1]?.path || '')"></span>
                  <span class="agent-activity-expand-hint text-muted">Click to expand</span>
                </div>
              </template>
              <template x-if="agentActivityExpanded">
                <div>
                  <div class="agent-activity-expand-hint mb-1" x-text="'Click to collapse (' + cursorAgentActivity.length + ' files)'"></div>
                  <template x-for="(act, i) in cursorAgentActivity" :key="i">
                    <div class="agent-activity-item">
                      <span class="agent-activity-label" x-text="act.label || act.path"></span>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </template>
        <template x-if="cursorPhase === 'assess' && cursorFileActivity.length">
          <div class="cursor-file-activity">
            <div class="cursor-file-activity-title">Folders & files discovered (Step 1)</div>
            <div class="cursor-file-activity-list">
              <template x-for="(act, i) in cursorFileActivity" :key="i">
                <div class="file-activity-item" :class="{ 'file-activity-done': act.done }">
                  <span class="file-activity-icon" x-text="act.action === 'dir' ? 'üìÅ' : (act.action === 'file' ? 'üìÑ' : '‚ãØ')"></span>
                  <span class="file-activity-label" x-text="act.label || act.path?.split(/[\\\\\\/]/).slice(-2).join('/') || '‚Ä¶'"></span>
                  <span class="file-activity-meta" x-show="act.count !== undefined" x-text="'(' + (act.count || 0) + ')'"></span>
                  <template x-if="act.files && act.files.length && act.done">
                    <div class="file-activity-files">
                      <template x-for="(fp, fi) in act.files.slice(0, 3)" :key="fi">
                        <span class="file-activity-path" x-text="fp.split(/[\\\\\\/]/).slice(-2).join('/') || fp"></span>
                      </template>
                      <span x-show="act.count > 3" x-text="'+' + (act.count - 3) + ' more'"></span>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </template>
        <template x-if="cursorPhase === 'assess' && cursorThinkingText">
          <div class="cursor-thinking-block">
            <div class="cursor-thinking-header">
              <span class="cursor-thinking-dots">
                <span class="dot"></span><span class="dot"></span><span class="dot"></span>
              </span>
              <span>Thinking</span>
            </div>
            <div class="cursor-thinking-text" style="white-space: pre-wrap;">
              <span x-text="formatThinkingForDisplay(cursorThinkingText)"></span>
              <span class="thinking-cursor"></span>
            </div>
          </div>
        </template>
        <div class="cursor-status-log cursor-status-log-live" x-show="cursorPhase !== 'assess'">
          <div class="cursor-stream-output" x-show="cursorStreamText">
            <span x-text="cursorStreamText"></span>
            <span class="stream-cursor" x-show="cursorWaiting"></span>
          </div>
          <template x-if="!cursorStreamText">
            <template x-for="(item, i) in cursorStatus.slice(-24)" :key="i">
              <div class="cursor-log-line" :class="'log-' + (item.type || 'status')" x-text="item.text"></div>
            </template>
          </template>
        </div>
      </div>
              </div>
              <div class="chat-composer chat-composer-openwebui p-3 border rounded">
                <div class="composer-bar d-flex align-items-center gap-2 flex-nowrap">
                  <div class="topic-pill-dropdown" @click.outside="topicMenuOpen = false">
                    <button type="button" class="topic-pill-btn" @click="topicMenuOpen = !topicMenuOpen">
                      <span class="topic-pill-icon">‚óâ</span>
                      <span class="topic-pill-label" x-text="chatTopicLabels[chatTopic] || chatTopic"></span>
                      <span class="topic-pill-chevron">‚ñº</span>
                    </button>
                    <div class="topic-pill-menu" x-show="topicMenuOpen" x-transition x-cloak>
                      <button type="button" class="topic-pill-option" @click="chatTopic = 'planning'; topicMenuOpen = false">Planning</button>
                      <button type="button" class="topic-pill-option" @click="chatTopic = 'prioritization'; topicMenuOpen = false">Prioritization</button>
                      <button type="button" class="topic-pill-option" @click="chatTopic = 'tasks'; topicMenuOpen = false">Tasks</button>
                      <button type="button" class="topic-pill-option" @click="chatTopic = 'general'; topicMenuOpen = false">General</button>
                      <button type="button" class="topic-pill-option" @click="chatTopic = 'agents'; topicMenuOpen = false">Agents</button>
                      <button type="button" class="topic-pill-option" @click="chatTopic = 'refactoring'; topicMenuOpen = false">Refactoring</button>
                    </div>
                  </div>
                  <input type="text" class="form-control composer-input flex-grow-1" x-show="!pendingQuestions || !pendingQuestions.length"
                    :placeholder="['planning','tasks'].includes(chatTopic) ? 'Describe what you want to plan...' : (chatTopic === 'prioritization' ? 'Click Send to have the LLM prioritize tasks...' : 'Ask anything...')"
                    x-model="projectChatInput" @keydown.enter.prevent="handleSend()">
                  <input type="text" class="form-control composer-input flex-grow-1" x-show="pendingQuestions && pendingQuestions.length"
                    :placeholder="'Answer question ' + (currentQuestionIndex + 1)" x-model="pendingQuestions[currentQuestionIndex].answer"
                    @keydown.enter.prevent="generatePlanFromAnswers()">
                  <button type="button" class="btn btn-send" @click="handleSend()" title="Send">
                    <span class="send-icon">‚Üë</span>
                  </button>
                </div>
                <details class="chat-context-details mt-2">
                  <summary class="chat-context-label" style="cursor: pointer;">Include in context</summary>
                  <div class="chat-context-tasks mt-1" x-show="mapNodes.length">
                    <template x-for="n in mapNodes" :key="n.id">
                      <label class="chat-context-item">
                        <input type="checkbox" :checked="chatSelectedTaskIds.includes(n.id)" @change="toggleChatTask(n.id)">
                        <span class="chat-context-text" x-text="n.title"></span>
                      </label>
                    </template>
                  </div>
                  <div class="chat-context-features" x-show="features.length">
                    <template x-for="f in features" :key="f.id">
                      <label class="chat-context-item">
                        <input type="checkbox" :checked="chatSelectedFeatureIds.includes(f.id)" @change="toggleChatFeature(f.id)">
                        <span class="chat-context-text" x-text="f.name"></span>
                      </label>
                    </template>
                  </div>
                  <div class="text-muted small" x-show="!mapNodes.length && !features.length">Load a project first.</div>
                  <button type="button" class="btn btn-link btn-sm text-muted mt-1 p-0 dev-test-link" @click="testCursor()" title="Test Cursor stream">Test stream</button>
                </details>
              </div>
            </div>
          </div>
        </div>

        <!-- Detailed Analysis tab -->
        <div class="analysis-view" x-show="mainTab === 'analysis'">
          <div class="analysis-centering">
            <section class="project-title-section mb-3" x-show="project.name">
              <h1 class="page-title mb-2" x-text="project.name"></h1>
              <span class="project-type-badge" x-text="project.type"></span>
            </section>
            <div class="assessment-content p-4 rounded border" style="max-height: 70vh; overflow-y: auto;">
              <template x-if="assessmentSections">
                <div class="assessment-sections">
                  <section class="assessment-section assessment-overview-standalone mb-3" x-show="assessmentSections.overview">
                    <h6 class="assessment-section-title">Overview</h6>
                    <p class="assessment-section-body" x-text="assessmentSections.overview" style="white-space: pre-wrap;"></p>
                  </section>
                  <section class="assessment-section" x-show="assessmentSections.analysis">
                    <h6 class="assessment-section-title">Detailed Analysis</h6>
                    <div class="assessment-analysis-paragraphs">
                      <template x-for="(p, pi) in (assessmentSections.analysis || '').split(/\n\n+/).filter(Boolean)" :key="pi">
                        <p class="assessment-section-body mb-2" x-text="p"></p>
                      </template>
                    </div>
                  </section>
                </div>
              </template>
              <template x-if="!assessmentSections && project.assessment">
                <div class="assessment-fallback" x-text="formatAssessmentForDisplay(project.assessment)" style="white-space: pre-wrap;"></div>
              </template>
              <div class="text-muted" x-show="!project.assessment && !assessmentSections">
                No detailed analysis yet. Load a project and run Reassess to generate analysis.
              </div>
            </div>
          </div>
        </div>

        <!-- Board tab -->
        <div class="board-view" x-show="mainTab === 'board'">
      <section class="project-title-section mb-3" x-show="project.name">
        <div class="d-flex align-items-start gap-2 flex-wrap">
          <div class="flex-grow-1">
            <h1 class="page-title mb-0" x-text="project.name"></h1>
            <span class="project-type-badge" x-text="project.type"></span>
            <div class="project-summary-block mt-2" x-show="project.summary">
              <div class="text-uppercase small text-muted mb-1">Project summary</div>
              <p class="project-summary-text mb-0" x-text="project.summary"></p>
            </div>
          </div>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-secondary" @click="openProjectModal()">Edit</button>
            <button class="btn btn-sm btn-outline-primary" x-show="project.root_path" @click="reassessProject()">Reassess</button>
            <button class="btn btn-sm btn-outline-secondary" x-show="project.root_path" @click="openAssessHistoryModal()">Assessment history</button>
            <button class="btn btn-sm btn-outline-danger" @click="deleteProject()">Remove</button>
          </div>
        </div>
        <div class="project-assessment mt-3 p-3 rounded border border-warning" x-show="!project.summary && !project.assessment && project.root_path">
          <p class="text-muted mb-0 small">No assessment yet. Run <strong>Reassess</strong> to analyze this project.</p>
        </div>
      </section>

      <section class="board-section">
          <div class="board-columns">
            <template x-for="col in columns" :key="col.id">
              <div class="board-column">
                <div class="column-header">
                  <span class="column-title" x-text="col.label"></span>
                  <span class="column-count" x-text="nodesByStatus[col.id]?.length || 0"></span>
                </div>
                <div class="column-cards" @dragover.prevent @dragenter="dragOverColumn = col.id" @dragleave="dragOverColumn = null" @drop="dropNode($event, col.id)" :class="dragOverColumn === col.id ? 'drag-over' : ''">
                  <template x-for="feat in features" :key="feat.id">
                    <template x-if="(nodesByStatusAndFeature[col.id][feat.id] || []).length">
                      <div class="feature-group">
                        <div class="feature-group-header" x-text="feat.name"></div>
                        <template x-for="node in (nodesByStatusAndFeature[col.id][feat.id] || [])" :key="node.id">
                          <div class="map-card" draggable="true" @dragstart="dragNode($event, node)" @dragend="document.querySelectorAll('.map-card').forEach(el => el.classList.remove('dragging'))" :class="'status-' + node.status">
                            <div class="card-title" x-text="node.title"></div>
                            <div class="card-prompts">
                              <span class="priority-badge" x-show="node.priority" :class="'priority-' + node.priority" x-text="node.priority"></span>
                              <span class="prompt-badge" :class="'prompt-' + (node.prompt_status || 'pending')" x-text="(node.prompt_status || 'pending').replace('_',' ')"></span>
                              <span class="agent-badge" x-show="node.agent_id" x-text="getAgentById(node.agent_id)?.name || node.agent_id"></span>
                              <span class="complexity-badge" x-show="node.complexity" :class="'complexity-' + node.complexity" x-text="node.complexity"></span>
                              <button class="btn btn-sm btn-link p-0 ms-1" @click.stop="openPromptModal(node)" x-show="node.prompt_status !== 'approved'">Review</button>
                            </div>
                            <div class="card-meta" x-show="node.description" x-text="node.description"></div>
                            <div class="card-footer">
                              <span class="card-assignee" x-text="getUserById(node.assignee_id)?.name || '‚Äî'"></span>
                              <div class="card-progress" x-show="node.progress !== undefined">
                                <div class="progress-bar" :style="'width:' + (node.progress || 0) + '%'"></div>
                              </div>
                            </div>
                            <div class="card-actions">
                              <button class="btn btn-sm btn-link" @click="openNodeModal(node)">Edit</button>
                              <select class="form-select form-select-sm" style="width: auto; height: 24px; font-size: 0.7rem;" @change="assignNode(node, $event.target.value)">
                                <option value="">Assign</option>
                                <template x-for="u in users" :key="u.id">
                                  <option :value="u.id" :selected="node.assignee_id === u.id" x-text="u.name"></option>
                                </template>
                              </select>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                  </template>
                  <template x-for="node in (nodesByStatusAndFeature[col.id]['_none'] || [])" :key="node.id">
                    <div class="map-card" draggable="true" @dragstart="dragNode($event, node)" @dragend="document.querySelectorAll('.map-card').forEach(el => el.classList.remove('dragging'))" :class="'status-' + node.status">
                      <div class="card-title" x-text="node.title"></div>
                      <div class="card-prompts">
                        <span class="priority-badge" x-show="node.priority" :class="'priority-' + node.priority" x-text="node.priority"></span>
                        <span class="agent-badge" x-show="node.agent_id" x-text="getAgentById(node.agent_id)?.name || node.agent_id"></span>
                        <span class="prompt-badge" :class="'prompt-' + (node.prompt_status || 'pending')" x-text="(node.prompt_status || 'pending').replace('_',' ')"></span>
                        <span class="complexity-badge" x-show="node.complexity" :class="'complexity-' + node.complexity" x-text="node.complexity"></span>
                        <button class="btn btn-sm btn-link p-0 ms-1" @click.stop="openPromptModal(node)" x-show="node.prompt_status !== 'approved'">Review</button>
                      </div>
                      <div class="card-meta" x-show="node.description" x-text="node.description"></div>
                      <div class="card-footer">
                        <span class="card-assignee" x-text="getUserById(node.assignee_id)?.name || '‚Äî'"></span>
                        <div class="card-progress" x-show="node.progress !== undefined">
                          <div class="progress-bar" :style="'width:' + (node.progress || 0) + '%'"></div>
                        </div>
                      </div>
                      <div class="card-actions">
                        <button class="btn btn-sm btn-link" @click="openNodeModal(node)">Edit</button>
                        <select class="form-select form-select-sm" style="width: auto; height: 24px; font-size: 0.7rem;" @change="assignNode(node, $event.target.value)">
                          <option value="">Assign</option>
                          <template x-for="u in users" :key="u.id">
                            <option :value="u.id" :selected="node.assignee_id === u.id" x-text="u.name"></option>
                          </template>
                        </select>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </section>
        </div>

        <!-- Features tab -->
        <div class="features-view" x-show="mainTab === 'features'">
      <section class="project-title-section mb-3" x-show="project.name">
        <h1 class="page-title mb-0" x-text="project.name"></h1>
        <span class="project-type-badge" x-text="project.type"></span>
      </section>
        <section class="tree-section features-section">
          <div class="features-toolbar mb-3 d-flex align-items-center justify-content-between">
            <span class="text-muted small">Features and modules</span>
            <button class="btn btn-sm btn-primary" @click="openAddFeatureModal()">+ Add feature</button>
          </div>
          <div class="tree-container">
            <div class="tree-item tree-project">
              <span class="tree-type" x-text="project.type"></span>
              <span class="tree-title" x-text="project.name || 'Project'"></span>
            </div>
            <div x-show="!features.length" class="text-muted small py-3">No features yet. Click "Add feature" to create one.</div>
            <template x-for="feat in treeRoots" :key="feat.id">
              <div class="tree-node" x-data="{ open: true }">
                <div class="tree-item tree-feature d-flex align-items-center" @click="open = !open">
                  <span class="tree-toggle" x-text="open ? '‚ñº' : '‚ñ∂'"></span>
                  <span class="tree-feature-name flex-grow-1" x-text="feat.name"></span>
                  <span class="tree-module-count" x-text="getChildren(feat.id).length + ' modules'"></span>
                  <button class="btn btn-link btn-sm p-0 ms-1" @click.stop="openEditFeatureModal(feat)" title="Edit feature">‚úé</button>
                  <button class="btn btn-link btn-sm p-0 text-danger ms-1" @click.stop="deleteFeature(feat.id)" title="Delete feature">√ó</button>
                </div>
                <div class="tree-feature-desc text-muted small px-3 py-2" x-show="open && feat.description" x-text="feat.description"></div>
                <div class="tree-children" x-show="open">
                  <template x-for="mod in getChildren(feat.id)" :key="mod.id">
                    <div class="tree-node child">
                      <div class="tree-item tree-module">
                        <span class="tree-badge" :class="'status-' + mod.status" x-text="mod.status"></span>
                        <span class="tree-title" x-text="mod.title"></span>
                        <span class="prompt-badge small" :class="'prompt-' + (mod.prompt_status || 'pending')" x-text="(mod.prompt_status || 'pending').replace('_',' ')"></span>
                        <span class="tree-assignee" x-text="getUserById(mod.assignee_id)?.name"></span>
                        <span class="tree-progress" x-show="mod.progress !== undefined" x-text="(mod.progress || 0) + '%'"></span>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </section>
        </div>

        <!-- Folder tab -->
        <div class="folder-view" x-show="mainTab === 'folder'">
      <section class="project-title-section mb-3" x-show="project.name">
        <h1 class="page-title mb-0" x-text="project.name"></h1>
        <span class="project-type-badge" x-text="project.type"></span>
      </section>
        <section class="folder-section">
          <div class="tree-container">
            <div class="folder-tree-header mb-2 d-flex justify-content-between align-items-center">
              <span class="text-muted small">Project folder structure</span>
              <button class="btn btn-sm btn-outline-secondary" @click="fetchFolderTree()">Refresh</button>
            </div>
            <template x-if="folderTree">
              <div class="folder-tree">
                <template x-for="({ node, depth }) in flattenFolderTree(folderTree)" :key="node.path">
                  <div class="folder-tree-row" :style="'padding-left: ' + (depth * 16) + 'px'" @click="node.type === 'dir' && node.children?.length && toggleFolder(node.path)">
                    <span class="tree-toggle" x-show="node.type === 'dir' && node.children?.length" x-text="(folderExpanded[node.path] !== false) ? '‚ñº' : '‚ñ∂'"></span>
                    <span class="tree-icon" x-text="(node.type || 'dir') === 'dir' ? 'üìÅ' : 'üìÑ'"></span>
                    <span class="tree-name font-monospace" x-text="node.name"></span>
                  </div>
                </template>
              </div>
            </template>
            <div x-show="project.root_path && !folderTree" class="text-muted small">Loading folder structure...</div>
            <div x-show="project.root_path && folderTree === null" class="text-muted small">Could not load folder structure.</div>
            <div x-show="!project.root_path && mainTab === 'folder'" class="text-muted small">No folder path. Attach a project with a root path to see its structure.</div>
          </div>
        </section>
        </div>
      </main>
    </div>

    <div class="modal fade" id="nodeModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
          <div class="modal-header">
            <h5 class="modal-title" x-text="editingNode?.title || 'Task'"></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" x-show="editingNode">
            <ul class="nav nav-tabs mb-3">
              <li class="nav-item">
                <button class="nav-link" :class="editModalTab === 'details' ? 'active' : ''" @click="editModalTab = 'details'">Details</button>
              </li>
              <li class="nav-item">
                <button class="nav-link d-flex align-items-center gap-1" :class="editModalTab === 'audit' ? 'active' : ''" @click="editModalTab = 'audit'">
                  Audit
                  <span class="badge bg-secondary" x-show="editingNode?.audit?.length" x-text="editingNode?.audit?.length || 0"></span>
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link d-flex align-items-center gap-1" :class="editModalTab === 'questions' ? 'active' : ''" @click="editModalTab = 'questions'">
                  Questions
                  <span class="badge bg-warning text-dark" x-show="(editingNode?.questions || []).filter(q => !q.answered).length" x-text="(editingNode?.questions || []).filter(q => !q.answered).length"></span>
                </button>
              </li>
            </ul>

            <div x-show="editModalTab === 'details'">
              <div class="row">
                <div class="col-md-6 mb-2">
                  <label class="form-label small">Title</label>
                  <input class="form-control" x-model="editingNode.title">
                </div>
                <div class="col-md-3 mb-2">
                  <label class="form-label small">Status</label>
                  <select class="form-select" x-model="editingNode.status">
                    <option value="todo">To Do</option>
                    <option value="ready_for_agent">Ready for Agent</option>
                    <option value="in_progress">In Progress</option>
                    <option value="in_review">In Review</option>
                    <option value="done">Done</option>
                  </select>
                </div>
                <div class="col-md-3 mb-2">
                  <label class="form-label small">Priority</label>
                  <select class="form-select" x-model="editingNode.priority">
                    <option value="">‚Äî</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                  </select>
                </div>
              </div>
              <div class="mb-2">
                <label class="form-label small">Description</label>
                <textarea class="form-control" rows="2" x-model="editingNode.description"></textarea>
              </div>
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label small">Progress %</label>
                  <input type="number" class="form-control" min="0" max="100" x-model="editingNode.progress">
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label small">Feature</label>
                  <select class="form-select" x-model="editingNode.feature_id">
                    <option value="">No feature</option>
                    <template x-for="f in features" :key="f.id">
                      <option :value="f.id" x-text="f.name"></option>
                    </template>
                  </select>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label small">Assignee</label>
                  <select class="form-select" x-model="editingNode.assignee_id">
                    <option value="">Unassigned</option>
                    <template x-for="u in users" :key="u.id">
                      <option :value="u.id" x-text="u.name"></option>
                    </template>
                  </select>
                </div>
              </div>
              <div class="mb-2">
                <label class="form-label small">Agent prompt</label>
                <textarea class="form-control" rows="3" x-model="editingNode.prompt" placeholder="LLM-generated instruction for this module"></textarea>
              </div>
              <div class="mb-2">
                <label class="form-label small">Complexity</label>
                <select class="form-select" x-model="editingNode.complexity">
                  <option value="simple">Simple ‚Äî quick review</option>
                  <option value="medium">Medium ‚Äî review recommended</option>
                  <option value="complex">Complex ‚Äî detailed review required</option>
                </select>
              </div>
            </div>

            <div x-show="editModalTab === 'audit'">
              <div class="audit-section">
                <div class="audit-agents mb-3">
                  <h6 class="text-muted small text-uppercase mb-2">Agents involved</h6>
                  <div class="d-flex flex-wrap gap-2">
                    <template x-for="aid in (editingNode?.agent_ids || [])" :key="aid">
                      <span class="agent-pill" x-text="getAgentById(aid)?.name || aid"></span>
                    </template>
                    <span class="text-muted small" x-show="!(editingNode?.agent_ids || []).length">No agents yet</span>
                  </div>
                </div>
                <h6 class="text-muted small text-uppercase mb-2">Activity & updates</h6>
                <div class="audit-timeline">
                  <template x-for="entry in getSortedAudit(editingNode)" :key="entry.id">
                    <div class="audit-entry">
                      <span class="audit-ts" x-text="formatTs(entry.ts)"></span>
                      <span class="audit-type" :class="'type-' + (entry.type || 'action')" x-text="(entry.type || 'action').replace('_',' ')"></span>
                      <span class="audit-actor" x-text="entry.agent_id ? (getAgentById(entry.agent_id)?.name || entry.agent_id) : (entry.user_id ? (getUserById(entry.user_id)?.name || entry.user_id) : '‚Äî')"></span>
                      <div class="audit-desc" x-text="entry.description"></div>
                      <div class="audit-details text-muted small" x-show="entry.details" x-text="entry.details"></div>
                    </div>
                  </template>
                  <div class="text-muted small" x-show="!getSortedAudit(editingNode).length">No activity yet</div>
                </div>
              </div>
            </div>

            <div x-show="editModalTab === 'questions'">
              <div class="questions-section">
                <p class="text-muted small mb-2">Questions the LLM needs answered to continue this task. Add your answer below.</p>
                <template x-for="q in (editingNode?.questions || [])" :key="q.id">
                  <div class="question-card" :class="q.answered ? 'answered' : 'pending'">
                    <div class="question-text" x-text="q.question"></div>
                    <div class="question-meta small text-muted">
                      <span x-text="(getAgentById(q.agent_id)?.name || 'Agent') + ' ¬∑ ' + formatTs(q.asked_at)"></span>
                    </div>
                    <div class="question-answer mt-2" x-show="q.answered">
                      <span class="answer-label">Answer:</span>
                      <span x-text="q.answer"></span>
                      <span class="text-muted small" x-text="(q.answered_by ? ' ‚Äî ' + (getUserById(q.answered_by)?.name || '') + ' ' + formatTs(q.answered_at) : '')"></span>
                    </div>
                    <div class="question-answer-form mt-2" x-show="!q.answered">
                      <div class="input-group">
                        <input type="text" class="form-control" placeholder="Type your answer..." :data-question-id="q.id" x-model="q.answerInput" @keydown.enter="answerQuestion(editingNode, q.id, q.answerInput || ''); q.answerInput = ''">
                        <button class="btn btn-primary" type="button" @click="answerQuestion(editingNode, q.id, q.answerInput || ''); q.answerInput = ''">Submit</button>
                      </div>
                    </div>
                  </div>
                </template>
                <div class="text-muted small" x-show="!(editingNode?.questions || []).length">No questions yet</div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" @click="saveTask()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="promptModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
          <div class="modal-header">
            <h5 class="modal-title">Review prompt ‚Äî <span x-text="reviewingNode?.title || ''"></span></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" x-show="reviewingNode">
            <div class="mb-2" x-show="reviewingNode?.complexity">
              <span class="complexity-badge mb-1" :class="'complexity-' + (reviewingNode?.complexity || '')" x-text="(reviewingNode?.complexity || '').replace('_', ' ')"></span>
              <span class="text-muted small ms-1" x-text="reviewingNode?.complexity === 'complex' ? '‚Äî Requires detailed review before approval' : (reviewingNode?.complexity === 'medium' ? '‚Äî Review recommended' : '‚Äî Quick review')"></span>
            </div>
            <div class="mb-2">
              <label class="form-label small">Agent prompt (editable before approval)</label>
              <textarea class="form-control font-monospace" rows="6" x-model="reviewingNode.prompt" placeholder="Generated instruction"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" @click="rejectPrompt()">Reject</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success" @click="approvePrompt()">Approve</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="attachModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content bg-dark">
          <div class="modal-header">
            <h5 class="modal-title">Attach existing project</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small">Select the folder of an existing codebase. The agent will assess it and produce a features list.</p>
            <div class="mb-2">
              <label class="form-label small">Project name</label>
              <input type="text" class="form-control" x-model="attachName" placeholder="My Project">
            </div>
            <div class="mb-2">
              <label class="form-label small">Folder path</label>
              <div class="d-flex gap-2">
                <input type="text" class="form-control font-monospace" x-model="attachPath" placeholder="Select a folder..." readonly>
                <button type="button" class="btn btn-outline-secondary" @click="openBrowseModal()">Browse</button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" @click="attachProject()" :disabled="!attachPath">Attach and assess</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="browseModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
          <div class="modal-header">
            <h5 class="modal-title">Select folder</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="browse-path-bar mb-2">
              <span class="text-muted small font-monospace" x-text="browseCurrentPath || 'Select a location'"></span>
            </div>
            <div class="browse-toolbar mb-2 d-flex gap-1 align-items-center">
              <button type="button" class="btn btn-sm btn-outline-secondary" @click="browseGoUp()" :disabled="!browseParentPath">
                ‚Üë Up
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" @click="browseLoad()" x-show="browseCurrentPath">
                ‚Üª Refresh
              </button>
              <button type="button" class="btn btn-sm btn-primary" x-show="browseCurrentPath" @click="selectFolder(browseCurrentPath)">
                Select this folder
              </button>
            </div>
            <div x-show="browseError" class="alert alert-danger py-2 mb-2" x-text="browseError"></div>
            <div class="browse-list border rounded" style="max-height: 280px; overflow-y: auto;">
              <template x-for="item in browseItems" :key="item.path">
                <div class="browse-item d-flex align-items-center gap-2 px-2 py-2 border-bottom border-secondary"
                  :class="{ 'bg-primary bg-opacity-25': item.path === attachPath, 'browse-item-dir': item.type === 'dir' }"
                  @click="item.type === 'dir' ? browseInto(item.path) : null">
                  <span x-text="item.type === 'dir' ? 'üìÅ' : 'üìÑ'"></span>
                  <span class="flex-grow-1" x-text="item.name"></span>
                  <button type="button" class="btn btn-sm btn-primary" x-show="item.type === 'dir'" @click.stop="selectFolder(item.path)">
                    Select
                  </button>
                </div>
              </template>
              <div x-show="browseLoading" class="p-3 text-center text-muted">Loading...</div>
              <div x-show="!browseLoading && !browseItems.length && !browseError" class="p-3 text-center text-muted">No folders here</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @click="closeBrowseModal()">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="projectModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content bg-dark">
          <div class="modal-header">
            <h5 class="modal-title">Edit project</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label small">Project name</label>
              <input type="text" class="form-control" x-model="editProjectName">
            </div>
            <div class="mb-2">
              <label class="form-label small">Project type</label>
              <input type="text" class="form-control" x-model="editProjectType" placeholder="e.g. Web App, API">
            </div>
            <div class="mb-2">
              <label class="form-label small">Description</label>
              <textarea class="form-control" rows="3" x-model="editProjectSummary" placeholder="Brief description of the project..."></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label small">Full assessment</label>
              <textarea class="form-control font-monospace" rows="8" x-model="editProjectAssessment" placeholder="Detailed analysis from assessment..."></textarea>
              <small class="text-muted">From Reassess or Attach. Edit to refine.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" @click="saveProject()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addFeatureModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content bg-dark">
          <div class="modal-header">
            <h5 class="modal-title">Add feature</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label small">Feature name</label>
              <input type="text" class="form-control" x-model="newFeatureName" placeholder="e.g. Authentication">
            </div>
            <div class="mb-2">
              <label class="form-label small">Description</label>
              <textarea class="form-control" rows="5" x-model="newFeatureDescription" placeholder="Detailed context for the AI: architecture, patterns, conventions, APIs, or constraints for this feature..."></textarea>
              <small class="text-muted">Used as reference when the agent implements tasks in this feature.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" @click="addFeature()">Add</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editFeatureModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
          <div class="modal-header">
            <h5 class="modal-title" x-text="editingFeature?.name || 'Edit feature'"></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" x-show="editingFeature">
            <div class="mb-2">
              <label class="form-label small">Feature name</label>
              <input type="text" class="form-control" x-model="editingFeature.name">
            </div>
            <div class="mb-2">
              <label class="form-label small">Description</label>
              <textarea class="form-control" rows="6" x-model="editingFeature.description" placeholder="Detailed context for the AI: architecture, patterns, conventions, APIs, or constraints..."></textarea>
              <small class="text-muted">Used as reference when the agent implements tasks in this feature.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" @click="saveFeature()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="assess-complete-overlay" x-show="showAssessCompleteModal" x-cloak x-transition
         @click.self="dismissAssessCompleteModal()">
      <div class="assess-complete-modal bg-dark border rounded shadow-lg m-3 overflow-hidden"
           @click.stop>
        <div class="assess-complete-header d-flex align-items-center justify-content-between p-3 border-bottom">
          <h5 class="mb-0">Assessment complete</h5>
          <button type="button" class="btn-close btn-close-white" @click="dismissAssessCompleteModal()"></button>
        </div>
        <div class="assess-complete-body p-3 overflow-auto" style="flex: 1;">
          <div class="assess-complete-folder mb-3" x-show="cursorAssessFolder">
            <div class="text-muted small text-uppercase mb-1">Folder assessed</div>
            <div class="font-monospace small text-break" x-text="cursorAssessFolder"></div>
          </div>
          <div class="assess-complete-section mb-4">
            <div class="text-muted small text-uppercase mb-2">Files scanned and read</div>
            <div class="assess-complete-files">
              <template x-for="(act, i) in cursorFileActivity" :key="i">
                <div class="assess-complete-file-item d-flex align-items-start gap-2 py-2 border-bottom border-secondary">
                  <span class="text-success flex-shrink-0" x-show="act.done">‚úì</span>
                  <span class="text-primary flex-shrink-0" x-show="!act.done">‚ãØ</span>
                  <div class="flex-grow-1 min-w-0">
                    <span class="font-monospace small" x-text="act.label"></span>
                    <span class="badge bg-secondary ms-1" x-show="act.count !== undefined" x-text="(act.count || 0)"></span>
                    <template x-if="act.files && act.files.length">
                      <div class="d-flex flex-wrap gap-1 mt-1">
                        <template x-for="(fp, fi) in (act.files || []).slice(0, 5)" :key="fi">
                          <span class="badge bg-primary bg-opacity-50 small" x-text="fp.split(/[\\\\\\/]/).slice(-2).join('/')"></span>
                        </template>
                        <span class="badge bg-secondary small" x-show="(act.count || 0) > 5" x-text="'+' + ((act.count || 0) - 5) + ' more'"></span>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <div class="assess-complete-section mb-4" x-show="project.assessment" x-data="{ assessModalTab: 'analysis' }">
            <div class="text-muted small text-uppercase mb-2">Detailed review</div>
            <div class="assess-complete-review p-3 rounded border overflow-auto">
              <template x-if="assessmentSections">
                <div class="assessment-sections">
                  <section class="assessment-section assessment-overview-standalone" x-show="assessmentSections.overview">
                    <h6 class="assessment-section-title">Overview</h6>
                    <p class="assessment-section-body" x-text="assessmentSections.overview" style="white-space: pre-wrap;"></p>
                  </section>
                  <div class="assessment-tabs mt-3" x-show="assessmentSections.analysis || (assessmentSections.features && assessmentSections.features.length)">
                    <ul class="nav nav-tabs assessment-nav-tabs" role="tablist">
                      <li class="nav-item" role="presentation" x-show="assessmentSections.analysis">
                        <button class="nav-link" :class="{ active: assessModalTab === 'analysis' }" type="button" @click="assessModalTab = 'analysis'" x-text="'Detailed Analysis'"></button>
                      </li>
                      <li class="nav-item" role="presentation" x-show="assessmentSections.features && assessmentSections.features.length">
                        <button class="nav-link" :class="{ active: assessModalTab === 'features' }" type="button" @click="assessModalTab = 'features'" x-text="'Features'"></button>
                      </li>
                    </ul>
                    <div class="tab-content assessment-tab-content pt-2">
                      <div class="tab-pane" :class="{ active: assessModalTab === 'analysis' }" x-show="(assessModalTab === 'analysis' || !(assessmentSections.features && assessmentSections.features.length)) && assessmentSections.analysis" role="tabpanel">
                        <div class="assessment-analysis-paragraphs">
                          <template x-for="(p, pi) in (assessmentSections.analysis || '').split(/\n\n+/).filter(Boolean)" :key="pi">
                            <p class="assessment-section-body mb-2" x-text="p"></p>
                          </template>
                        </div>
                      </div>
                      <div class="tab-pane" :class="{ active: assessModalTab === 'features' }" x-show="(assessModalTab === 'features' || !assessmentSections.analysis) && assessmentSections.features && assessmentSections.features.length" role="tabpanel">
                        <ul class="assessment-feature-list">
                          <template x-for="f in assessmentSections.features" :key="f.id || f.name">
                            <li class="assessment-feature-item">
                              <strong x-text="f.name"></strong>
                              <span x-show="f.id" class="text-muted small" x-text="' (' + f.id + ')'"></span>
                              <p class="assessment-feature-desc mb-0 mt-1" x-show="f.description" x-text="f.description" style="white-space: pre-wrap;"></p>
                            </li>
                          </template>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
              <template x-if="!assessmentSections && project.assessment">
                <div class="assessment-fallback" x-text="formatAssessmentForDisplay(project.assessment)" style="white-space: pre-wrap;"></div>
              </template>
            </div>
          </div>
          <div class="assess-complete-section" x-show="features.length">
            <div class="text-muted small text-uppercase mb-2">Features identified</div>
            <ul class="list-group">
              <template x-for="f in features" :key="f.id">
                <li class="list-group-item bg-dark border-secondary">
                  <strong x-text="f.name"></strong>
                  <div class="text-muted small mt-1" x-show="f.description" x-text="f.description"></div>
                </li>
              </template>
            </ul>
          </div>
        </div>
        <div class="assess-complete-footer p-3 border-top d-flex justify-content-end">
          <button type="button" class="btn btn-primary" @click="dismissAssessCompleteModal()">Continue</button>
        </div>
      </div>
    </div>

    <div class="assess-history-overlay" x-show="showAssessHistoryModal" x-cloak x-transition
         @click.self="closeAssessHistoryModal()">
      <div class="assess-history-modal bg-dark border rounded shadow-lg m-3 overflow-hidden"
           @click.stop style="max-width: 1000px; max-height: 90vh; width: 100%; display: flex; flex-direction: column;">
        <div class="assess-history-header d-flex align-items-center justify-content-between p-3 border-bottom">
          <h5 class="mb-0">Assessment history ‚Äî Full data logs</h5>
          <button type="button" class="btn-close btn-close-white" @click="closeAssessHistoryModal()"></button>
        </div>
        <div class="assess-history-body p-3 overflow-auto" style="flex: 1;">
          <template x-if="!assessHistory.length">
            <div class="text-muted">No assessment history yet. Run Reassess to create logs.</div>
          </template>
          <template x-if="assessHistory.length">
            <div class="assess-history-list">
              <template x-for="(entry, i) in assessHistory" :key="entry.id">
                <div class="assess-history-entry border rounded p-3 mb-3"
                     :class="{ 'border-primary': selectedAuditEntry?.id === entry.id }">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small" x-text="formatAuditDate(entry.created_at)"></span>
                    <button class="btn btn-sm btn-outline-primary" @click="selectedAuditEntry = selectedAuditEntry?.id === entry.id ? null : entry"
                            x-text="selectedAuditEntry?.id === entry.id ? 'Hide logs' : 'Show full logs'"></button>
                  </div>
                  <div class="small text-muted mb-1" x-show="selectedAuditEntry?.id === entry.id">
                    <strong>Prompt:</strong>
                    <pre class="audit-log-pre mb-2 mt-1 p-2 rounded overflow-auto" style="max-height: 150px;" x-text="entry.prompt_text"></pre>
                  </div>
                  <div class="small" x-show="selectedAuditEntry?.id === entry.id">
                    <strong>Full response (agent output):</strong>
                    <pre class="audit-log-pre mt-1 p-2 rounded overflow-auto" style="max-height: 400px; white-space: pre-wrap; word-break: break-word;" x-text="formatAssessmentForDisplay(entry.response_text)"></pre>
                  </div>
                  <div class="small" x-show="selectedAuditEntry?.id !== entry.id">
                    <span x-text="(entry.response_text || '').slice(0, 200) + ((entry.response_text || '').length > 200 ? '...' : '')"></span>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
        <div class="assess-history-footer p-3 border-top">
          <button type="button" class="btn btn-secondary" @click="closeAssessHistoryModal()">Close</button>
        </div>
      </div>
    </div>

    <div class="modal fade" id="newProjectModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content bg-dark">
          <div class="modal-header">
            <h5 class="modal-title">New project</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted small">Create a new project and use Generate with Cursor to build a plan.</p>
            <div class="mb-2">
              <label class="form-label small">Project name</label>
              <input type="text" class="form-control" x-model="newProjectName" placeholder="My Project">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" @click="createNewProject()">Create</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
